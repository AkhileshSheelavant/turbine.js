/*
 *   ________  ______  ____  _____   ________     _______
 *  /_  __/ / / / __ \/ __ )/  _/ | / / ____/    / / ___/
 *   / / / / / / /_/ / __  |/ //  |/ / __/  __  / /\__ \
 *  / / / /_/ / _, _/ /_/ // // /|  / /____/ /_/ /___/ /
 * /_/  \____/_/ |_/_____/___/_/ |_/_____(_)____//____/
 *
 * Turbine.js : The JavaScript Workflow Engine
 *
 * Copyright (c) 2012 Warren Benedetto <warren@transfusionmedia.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom the Software
 * is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
(function(c,e){var d=c.jQuery||null;var b=c.console||{};b.log=(typeof b.log==="function")?b.log:function(){};b.info=(typeof b.info==="function")?b.info:b.log;b.error=(typeof b.error==="function")?b.error:b.log;b.warn=(typeof b.warn==="function")?b.warn:b.log;Function.prototype.bind=function(g){var f=this;return function(){return f.apply(g,arguments)}};var a=function a(f){if(typeof f!=="object"||f===null){var g="Turbine constructor must be passed an initialization object";this.report("INIT_OBJ_NOT_DEFINED",g);throw new Error(g)}this.globalListeners={};this.globalTimeoutAllowed=false;this.logLevel=f.logLevel||"ERROR";this.name=f.name||"Turbine";this.numGlobalListeners=0;this.queries={};this.queryOrder=[];this.resets={};this.responses={};this.stopped=false;this.waitingFor=null;this.workflow={};this.timers={queries:{},delay:null,global:null};this.api=this.getPublicAPI();this.importFunctions(f);this.importObjects(f);this.importWorkflow(f);this.queue(this.getStartingQuery(),null)};a.prototype={defaultGlobalTimeout:3600000,globalListeners:null,globalTimeoutAllowed:null,logLevel:null,name:null,numGlobalListeners:null,queries:null,queryOrder:null,resets:null,responses:null,stopped:null,timers:null,waitingFor:null,workflow:null,logLevels:{OFF:0,ERROR:1,WARN:2,INFO:3,DEBUG:4},getPublicAPI:function(){return{getConfigVar:this.getConfigVar.bind(this),setResponse:this.setResponse.bind(this),start:this.start.bind(this),stop:this.stop.bind(this)}},importFunctions:function(f){this.log("importFunctions","Importing functions");var j=null;var l=["log","publish","listen","report","remove","compare"];var h={};for(var g=0;g<l.length;g++){j=l[g];this.log("importFunctions","--> Importing "+j+"() function",null,"DEBUG");if(typeof f[j]==="function"){this[j]=f[j];h[j]=true}}if(!d&&(!("publish" in h)||!("listen" in h)||!("remove" in h))){var k="["+this.name+".importFunctions()] You must either define publish(), listen(), and remove() functions via the initObj passed to the Turbine constructor, or you must include jQuery in the page.";this.report("REQUIRED_FUNCTIONS_NOT_DEFINED",k);throw new Error(k)}},importObjects:function(f){this.log("importObjects","Importing objects");var h=null;var j=["queries","resets","responses"];for(var g=0;g<j.length;g++){h=j[g];this.log("importObjects","--> Importing "+h+" object",null,"DEBUG");if(this.utils.isObjLiteral(f[h])){this[h]=f[h]}}},importWorkflow:function(f){if(this.utils.isObjLiteral(f.workflow)){this.log("importWorkflow","Importing workflow");this.workflow=f.workflow||{};this.workflow.config=f.workflow.config||{};this.workflow.config.shortcuts=f.workflow.config.shortcuts||{};this.workflow.config.variables=f.workflow.config.variables||{};this.workflow.config.always=f.workflow.config.always||{};this.workflow.mixins=f.workflow.mixins||{};if(this.utils.isObjLiteral(f.workflow.config)){this.importConfig(f.workflow)}if(this.utils.isObjLiteral(f.workflow.queries)){this.importQueries(f.workflow)}}else{var g="["+this.name+".importWorkflow()] Could not import workflow. Workflow must be an object literal.";this.report("COULD_NOT_IMPORT_WORKFLOW",g);throw new Error(g)}},importConfig:function(h){this.log("importConfig","Importing config",h);var f=this;if(h.config.always&&h.config.always.waitFor){for(var g in h.config.always.waitFor){if(h.config.always.waitFor.hasOwnProperty(g)){(function(i){f.importGlobalListener(i,h)}(h.config.always.waitFor[g]))}}}this.globalTimeoutAllowed=typeof h.config.always.timeout!=="undefined"},importQueries:function(i){this.log("importQueries","Importing queries",i);var h=0;for(var g in i.queries){if(i.queries.hasOwnProperty(g)){this.importQuery(g,i);h+=1}}if(h===0){var f="["+this.name+".importQueries()] The workflow has no queries to import";this.report("NO_QUERIES_TO_IMPORT",f);throw new Error(f)}},importQuery:function(g,h){this.log("importQuery","Importing workflow query: "+g,h.queries[g],"DEBUG");this.queries[g]=this.queries[g]||null;this.queryOrder.push(g);this.replaceMixins(g,h);for(var f in h.queries[g]){if(h.queries[g].hasOwnProperty(f)){this.importResponse(f,g,h)}}},importResponse:function(f,g,i){var h=i.queries[g][f];this.log("importResponse","Importing "+f+" response to "+g+" query",h,"DEBUG");if(h.repeat){h.repeat.counter=0}this.replaceShortcuts(h,i);this.replaceVariables(h,i)},log:function(h,f,g,i){g=(!g)?"":g;i=(!i)?"INFO":i;f="["+this.name+"."+h+"()] "+f;if(this.isLoggable(i)){if(i==="ERROR"){b.error(f,g)}else{if(i==="WARN"){b.warn(f,g)}else{if(i==="INFO"){b.info(f,g)}else{b.log(f,g)}}}}},isLoggable:function(h){var f=this.logLevels[this.logLevel];var g=this.logLevels[h];return g<=f},report:function(f,h,g){this.log("report",h+" ("+f+")",g,"ERROR")},publish:function(g,h,j){this.log("publish","Publishing message:",g);if(typeof g==="string"){g=[g]}for(var f=0;f<g.length;f++){d(this).trigger(g[f],h)}if(typeof j==="function"){j()}},listen:function(h,g){this.log("listen","Adding listener for:",h,"DEBUG");if(typeof h==="string"){h=[h]}for(var f=0;f<h.length;f++){d(this).bind(h[f],function(i){g(i.type,i.data)})}},remove:function(g){this.log("remove","Removing listener for:",g,"DEBUG");if(typeof g==="string"){g=[g]}for(var f=0;f<g.length;f++){d(this).unbind(g[f])}},compare:function(g,f){return g===f},start:function(){this.log("start","Starting Turbine");this.publish("Turbine|workflow|started");this.stopped=false;this.next()},stop:function(){this.log("stop","Stopping Turbine");this.stopped=true;this.rewind();this.publish("Turbine|workflow|stopped")},next:function(){if(this.isStopped()||this.nextQuery===null){return null}this.log("next","Executing next workflow query:",this.nextQuery);this.exec(this.nextQuery)},exec:function(h){this.clearTimers();if(this.isStopQuery(h)){this.stop()}if(this.isStopped()){return null}this.nextQuery=null;this.responses[h]=this.getResponse(h);var f=this.responses[h];var g=this.workflow.queries[h][f];if(!g){f="default";g=this.workflow.queries[h][f];if(!g){this.report("RESPONSE_DOES_NOT_EXIST","["+this.name+".exec()] "+f+" response does not exist for the "+h+" query");return null}}this.log("exec","Executing the "+f+" response to the "+h+" query");this.publish("Turbine|query|executed",{query:h,response:f,responseObj:g});g.responseName=f;this.processResponse(h,g)},processResponse:function(h,g,j){this.clearTimers();if(this.isStopped()){return null}this.log("processResponse","Processing response",g);if(!j){this.startGlobalTimeout(h,g)}if(g.delay&&!g.isAfterDelay){this.startDelayTimeout(h,g)}else{if(g.report&&!g.isPublishCallback){var f=this.responses[h];this.report(g.report,"Turbine reported "+g.report+' from "'+f+'" response of "'+h+'" query',{query:h,response:f,responseObj:this.workflow.queries[h][f]})}if(g.publish&&!g.waitFor&&!g.isPublishCallback){this.publishNow(h,g)}if(g.publish&&g.waitFor&&!g.isPublishCallback){this.publishAndWait(h,g)}else{if(g.repeat){if(g.isAfterDelay){try{delete g.isAfterDelay}catch(i){g.isAfterDelay=e}}this.repeat(h,g)}else{if(g.then){if(g.waitFor){if(this.isEarlierQuery(g.then,h)){this.rewind(h,g.then,g.waitFor)}else{this.queue(g.then,g.waitFor)}}else{this.exec(g.then)}}}if(g.isPublishCallback){try{delete g.isPublishCallback}catch(i){g.isPublishCallback=e}}if(g.timeout){this.setResponseTimeout(h,g)}if(g.isAfterDelay){try{delete g.isAfterDelay}catch(i){g.isAfterDelay=e}}}}},setResponseTimeout:function(i,g){if(!this.timers.queries[i]){this.timers.queries[i]=[]}var f=this;var h=setTimeout(function(){f.onResponseTimeout(i,g)},g.timeout.after);this.timers.queries[i].push(h)},repeat:function(g,f){f.repeat.counter+=1;this.log("repeat","Repeating "+g+" ("+f.repeat.counter+" of "+f.repeat.limit+" max)");if(f.repeat.limit===null){this.queue(g,f.waitFor)}else{if(f.repeat.counter>=f.repeat.limit){this.log("repeat","Maximum repeat limit for "+g+" reached or exceeded ("+f.repeat.counter+" of "+f.repeat.limit+" max)");this.publish("Turbine|limit|exceeded|REPEAT",{query:g,limit:f.repeat.limit});this.processResponse(g,f.repeat)}else{if(f.waitFor){if(this.utils.isArray(f.waitFor)&&f.repeat.counter>1){f.waitFor=f.waitFor.slice(0,f.waitFor.length-this.numGlobalListeners)}this.queue(g,f.waitFor)}else{this.exec(g)}}}},rewind:function(m,l,h){this.clearTimers();var j=false;var f=this.queryOrder.length;m=m||this.queryOrder[f-1];l=l||this.queryOrder[0];this.log("rewind","Rewinding from "+m+" to "+l);this.publish("Turbine|workflow|rewind",{from:m,to:l});for(var g=f;g>=0;g--){var k=this.queryOrder[g];if(k===m){j=true}if(j){this.clear(k)}if(k===l){break}}if(!this.isStopped()){this.queue(l,h)}},isEarlierQuery:function(h,g){if(g===h){return true}for(var f in this.queryOrder){if(this.queryOrder.hasOwnProperty(f)){if(this.queryOrder[f]===h){return true}if(this.queryOrder[f]===g){return false}}}return false},clear:function(g){this.log("clear","Clearing "+g,null,"DEBUG");this.clearQueryTimer(g);for(var f in this.workflow.queries[g]){if(this.workflow.queries[g].hasOwnProperty(f)&&this.workflow.queries[g][f].repeat){this.workflow.queries[g][f].repeat.counter=0}}this.resetResponse(g)},hasQueryFunction:function(f){return typeof this.queries[f]==="function"},hasResetFunction:function(f){return typeof this.resets[f]==="function"},resetResponse:function(f){if(this.hasResetFunction(f)){this.responses[f]=this.resets[f]()}else{this.responses[f]=null}},onResponseTimeout:function(g,f){this.log("onResponseTimeout","The "+g+" response timed out.",f,"WARN");if(this.waitingFor){this.remove(this.waitingFor)}this.publish("Turbine|timer|expired|WORKFLOW_RESPONSE_TIMEOUT",{query:g,response:f.responseName,responseObj:f});f.timeout.isAfterTimeout=true;this.processResponse(g,f.timeout,true)},publishNow:function(h,f){var g=null;var i={};if(this.utils.isObjLiteral(f.publish)){g=f.publish.message;i=this.getUsingObject(f.publish.using)}else{g=f.publish}this.publish(g,i)},publishAndWait:function(i,g){var f=this;var h=null;var j={};if(this.utils.isObjLiteral(g.publish)){h=g.publish.message;j=this.getUsingObject(g.publish.using)}else{h=g.publish}j.counter=(typeof g.repeat!=="undefined")?g.repeat.counter:0;this.log("publishAndWait","Publishing message and waiting for response",{message:h,using:j,response:g});var k=function(){g.isPublishCallback=true;f.processResponse(i,g)};this.publish(h,j,k)},getUsingObject:function(f){f=(typeof f==="undefined")?{}:f;if(this.workflow.config.always&&this.workflow.config.always.using){f=this.utils.mergeObjects(f,this.workflow.config.always.using)}this.log("getUsingObject","Getting using object",f,"DEBUG");return f},startDelayTimeout:function(h,g){this.log("startDelayTimeout",h+" delay started. Delayed for "+g.delay+" ms",g);this.publish("Turbine|delay|started",{query:h,delay:g.delay+" ms"});var f=this;this.timers.delay=setTimeout(function(){f.onDelayTimeout(h,g)},g.delay)},onDelayTimeout:function(g,f){this.log("onDelayTimeout",g+" delay completed after "+f.delay+" ms",f);this.publish("Turbine|delay|completed",{query:g,delay:f.delay+" ms"});f.isAfterDelay=true;this.processResponse(g,f)},getStartingQuery:function(){var f=this.getConfigShortcut("start");return(f)?f:this.queryOrder[0]},importGlobalListener:function(g,j){this.log("importGlobalListener","Importing global listener",g,"DEBUG");this.replaceShortcuts(g,j);this.replaceVariables(g,j);if(typeof g.waitFor==="string"){g.waitFor=[g.waitFor]}for(var f=0;f<g.waitFor.length;f++){var h=g.waitFor[f];this.globalListeners[h]=g;this.numGlobalListeners+=1}},queue:function(g,f){if(this.waitingFor){this.remove(this.waitingFor)}this.waitingFor=this.buildWaitingForObj(f);this.nextQueryObj=this.buildNextQueryObj(g,this.waitingFor);this.nextQuery=g;this.log("queue","Queuing "+g+" query",this.waitingFor);this.publish("Turbine|workflow|waiting",{waitingFor:this.waitingFor});this.listen(this.waitingFor,this.handleIncomingMessage.bind(this))},buildWaitingForObj:function(h){var k=(h)?h:[];if(!this.utils.isArray(k)){k=[k]}for(var j in this.globalListeners){if(this.globalListeners.hasOwnProperty(j)){for(var g=0;g<this.globalListeners[j].waitFor.length;g++){var f=this.globalListeners[j].waitFor[g];if(!this.utils.inArray(f,k)){k.push(f)}}}}return k},buildNextQueryObj:function(h,k){var f={};for(var g=0;g<k.length;g++){f[k[g]]=h}for(var j in this.globalListeners){if(this.globalListeners.hasOwnProperty(j)){f[j]=this.globalListeners[j].then}}return f},handleIncomingMessage:function(f,g){if(this.isStopped()){return null}this.log("handleIncomingMessage",'Handling "'+f+'" message',g);if(this.waitingFor){this.remove(this.waitingFor);this.nextQuery=this.getNextQuery(f)}this.publish("Turbine|message|handled",{handledMessage:f,next:this.nextQuery});this.waitingFor=null;this.next();return true},getNextQuery:function(g){var f=null;for(var h in this.nextQueryObj){if(this.nextQueryObj.hasOwnProperty(h)&&this.compare(g,h)){f=this.nextQueryObj[h];break}}this.log("getNextQuery","Getting the next query: "+f,null,"DEBUG");return f},clearTimers:function(){this.log("clearTimers","Clearing all timers",this.timers,"DEBUG");this.clearAllQueryTimers();this.clearGlobalTimer();this.clearDelayTimer()},clearAllQueryTimers:function(){this.log("clearAllQueryTimers","Clearing all query timers",this.timers.queries,"DEBUG");for(var f in this.timers.queries){if(this.timers.queries.hasOwnProperty(f)){this.clearQueryTimer(f)}}},clearQueryTimer:function(h){var g=this.timers.queries[h];if(g){this.log("clearQueryTimer","Clearing "+h+" query timer",this.timers.queries[h],"DEBUG");for(var f=0;f<g.length;f++){clearTimeout(g[f])}try{delete this.timers.queries[h]}catch(j){this.timers.queries[h]=e}}},clearGlobalTimer:function(){if(this.timers.global!==null){this.log("clearGlobalTimer","Clearing global timer",this.timers.global,"DEBUG");clearTimeout(this.timers.global);this.timers.global=null}},clearDelayTimer:function(){if(this.timers.delay!==null){this.log("clearDelayTimer","Clearing delay timer",this.timers.delay,"DEBUG");clearTimeout(this.timers.delay);this.timers.delay=null}},startGlobalTimeout:function(i,g){if(!this.isGlobalTimeoutAllowed()){return false}this.clearGlobalTimer();this.log("startGlobalTimeout","Starting global timer",this.workflow.config.always.timeout,"DEBUG");var h=this.getGlobalTimeout();var f=this;this.timers.global=setTimeout(function(){f.onGlobalTimeout(i,g)},h);return true},getGlobalTimeout:function(){if(this.utils.isObjLiteral(this.workflow.config)&&this.utils.isObjLiteral(this.workflow.config.always)&&this.utils.isObjLiteral(this.workflow.config.always.timeout)&&this.workflow.config.always.timeout.after){return this.workflow.config.always.timeout.after}else{return this.defaultGlobalTimeout}},onGlobalTimeout:function(g,f){if(this.waitingFor){this.remove(this.waitingFor)}this.log("onGlobalTimeout","Turbine timed out on "+g+" query after "+this.getGlobalTimeout()+" ms",null,"ERROR");this.publish("Turbine|timer|expired|WORKFLOW_GLOBAL_TIMEOUT",{query:g,response:f.responseName,responseObj:f});this.workflow.config.always.timeout.isAfterTimeout=true;this.processResponse(null,this.workflow.config.always.timeout,true)},isGlobalTimeoutAllowed:function(){return this.globalTimeoutAllowed===true},isStopped:function(){return this.stopped===true},isStopQuery:function(f){return f==="done"},setResponse:function(g,f){this.log("setResponse",'Setting "'+g+'" response to '+f);this.responses[g]=f},getResponse:function(f){this.responses[f]=(this.hasQueryFunction(f))?this.queries[f]():this.responses[f];if(typeof this.responses[f]==="boolean"||!this.responses[f]){this.responses[f]=(this.responses[f])?"yes":"no"}this.log("getResponse",f+"?",this.responses[f]);return this.responses[f]},getConfigVar:function(f){f=(f.indexOf("$")!==0)?"$"+f:f;return(this.utils.isObjLiteral(this.workflow.config.variables))?this.workflow.config.variables[f]:null},getConfigShortcut:function(f){f=(f.indexOf("@")!==0)?"@"+f:f;return(this.utils.isObjLiteral(this.workflow.config)&&this.utils.isObjLiteral(this.workflow.config.shortcuts))?this.workflow.config.shortcuts[f]:null},replaceVariables:function(f,g){this.replace(f,g.config.variables,"$",true,"variable")},replaceShortcuts:function(f,g){this.replace(f,g.config.shortcuts,"@",true,"shortcut")},replaceMixins:function(f,g){this.replace(g.queries[f],g.mixins,"!",true,"mixin")},replace:function(l,k,f,g,i){for(var j in l){if(l.hasOwnProperty(j)){var h=l[j];if(typeof h==="string"&&h.indexOf(f)===0){if(k[h]){this.log("replace","Replacing "+h+" "+i+" with",k[h],"DEBUG");l[j]=k[h]}}else{if(g&&typeof h==="object"){this.replace(h,k,f,g,i)}}}}},utils:{isArray:function(f){return Object.prototype.toString.call(f)==="[object Array]"},inArray:function(g,h){for(var f=0;f<h.length;f++){if(g===h[f]){return true}}return false},isObjLiteral:function(f){return typeof f==="object"&&f!==null&&!this.isArray(f)},mergeObjects:function(h,g){for(var f in g){if(g.hasOwnProperty(f)){if((typeof h[f]==="object"&&h[f]!==null)&&(typeof g[f]==="object"&&g[f]!==null)){h[f]=this.mergeObjects(h[f],g[f])}else{h[f]=g[f]}}}return h}}};c.Turbine=a}(window));