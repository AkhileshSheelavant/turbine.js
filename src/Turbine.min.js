/** @license Turbine.js | MIT License | https://github.com/wmbenedetto/turbine.js#mit-license */(function(e,t){var n=e.jQuery||null;Function.prototype.bind=function(e){var t=this;return function(){return t.apply(e,arguments)}};var i=function(t){if(typeof t!="object"||t===null){var n="Turbine constructor must be passed an initialization object";throw this.report("INIT_OBJ_NOT_DEFINED",n),new Error(n)}this.globalListeners={},this.globalTimeoutAllowed=!1,this.logLevel=t.logLevel||"ERROR",this.name=t.name||"Turbine",this.numGlobalListeners=0,this.queries={},this.queryOrder=[],this.resets={},this.responses={},this.stopped=!1,this.waitingFor=null,this.workflow={},this.timers={queries:{},delay:null,global:null},this.api=this.getPublicAPI(),this.importFunctions(t),this.importObjects(t),this.importWorkflow(t),this.queue(this.getStartingQuery(),null)};i.prototype={defaultGlobalTimeout:36e5,globalListeners:null,globalTimeoutAllowed:null,logLevel:null,name:null,numGlobalListeners:null,queries:null,queryOrder:null,resets:null,responses:null,stopped:null,timers:null,waitingFor:null,workflow:null,logLevels:{OFF:0,ERROR:1,WARN:2,INFO:3,DEBUG:4},getPublicAPI:function(){return{getConfigVar:this.getConfigVar.bind(this),setResponse:this.setResponse.bind(this),start:this.start.bind(this),stop:this.stop.bind(this)}},importFunctions:function(e){var t=null,r=["log","publish","listen","report","remove","compare"],i={};for(var s=0;s<r.length;s++)t=r[s],typeof e[t]=="function"&&(this[t]=e[t],i[t]=!0);if(!n&&(!("publish"in i)||!("listen"in i)||!("remove"in i))){var o="["+this.name+".importFunctions()] You must either define publish(), listen(), and remove() functions via the initObj passed to the Turbine constructor, or you must include jQuery in the page.";throw this.report("REQUIRED_FUNCTIONS_NOT_DEFINED",o),new Error(o)}},importObjects:function(e){var t=null,n=["queries","resets","responses"];for(var r=0;r<n.length;r++)t=n[r],this.utils.isObjLiteral(e[t])&&(this[t]=e[t])},importWorkflow:function(e){if(!this.utils.isObjLiteral(e.workflow)){var t="["+this.name+".importWorkflow()] Could not import workflow. Workflow must be an object literal.";throw this.report("COULD_NOT_IMPORT_WORKFLOW",t),new Error(t)}this.workflow=e.workflow||{},this.workflow.config=e.workflow.config||{},this.workflow.config.shortcuts=e.workflow.config.shortcuts||{},this.workflow.config.variables=e.workflow.config.variables||{},this.workflow.config.always=e.workflow.config.always||{},this.workflow.mixins=e.workflow.mixins||{},this.utils.isObjLiteral(e.workflow.config)&&this.importConfig(e.workflow),this.utils.isObjLiteral(e.workflow.queries)&&this.importQueries(e.workflow)},importConfig:function(e){var t=this;if(e.config.always&&e.config.always.waitFor)for(var n in e.config.always.waitFor)e.config.always.waitFor.hasOwnProperty(n)&&function(n){t.importGlobalListener(n,e)}(e.config.always.waitFor[n]);this.globalTimeoutAllowed=typeof e.config.always.timeout!="undefined"},importQueries:function(e){var t=0;for(var n in e.queries)e.queries.hasOwnProperty(n)&&(this.importQuery(n,e),t+=1);if(t===0){var r="["+this.name+".importQueries()] The workflow has no queries to import";throw this.report("NO_QUERIES_TO_IMPORT",r),new Error(r)}},importQuery:function(e,t){this.queries[e]=this.queries[e]||null,this.queryOrder.push(e),this.replaceMixins(e,t);for(var n in t.queries[e])t.queries[e].hasOwnProperty(n)&&this.importResponse(n,e,t)},importResponse:function(e,t,n){var r=n.queries[t][e];r.repeat&&(r.repeat.counter=0),this.replaceShortcuts(r,n),this.replaceVariables(r,n)},log:function(e,t,n,i){},isLoggable:function(e){},report:function(e,t,n){},publish:function(e,t,r){typeof e=="string"&&(e=[e]);for(var i=0;i<e.length;i++)n(this).trigger(e[i],t);typeof r=="function"&&r()},listen:function(e,t){typeof e=="string"&&(e=[e]);for(var r=0;r<e.length;r++)n(this).bind(e[r],function(e){t(e.type,e.data)})},remove:function(e){typeof e=="string"&&(e=[e]);for(var t=0;t<e.length;t++)n(this).unbind(e[t])},compare:function(e,t){return e===t},start:function(){this.publish("Turbine|workflow|started"),this.stopped=!1,this.next()},stop:function(){this.stopped=!0,this.rewind(),this.publish("Turbine|workflow|stopped")},next:function(){if(this.isStopped()||this.nextQuery===null)return null;this.exec(this.nextQuery)},exec:function(e){this.clearTimers(),this.isStopQuery(e)&&this.stop();if(this.isStopped())return null;this.nextQuery=null,this.responses[e]=this.getResponse(e);var t=this.responses[e],n=this.workflow.queries[e][t];if(!n){t="default",n=this.workflow.queries[e][t];if(!n)return this.report("RESPONSE_DOES_NOT_EXIST","["+this.name+".exec()] "+t+" response does not exist for the "+e+" query"),null}this.publish("Turbine|query|executed",{query:e,response:t,responseObj:n}),n.responseName=t,this.processResponse(e,n)},processResponse:function(e,n,r){this.clearTimers();if(this.isStopped())return null;r||this.startGlobalTimeout(e,n);if(n.delay&&!n.isAfterDelay)this.startDelayTimeout(e,n);else{if(n.report&&!n.isPublishCallback){var i=this.responses[e];this.report(n.report,"Turbine reported "+n.report+' from "'+i+'" response of "'+e+'" query',{query:e,response:i,responseObj:this.workflow.queries[e][i]})}n.publish&&!n.waitFor&&!n.isPublishCallback&&this.publishNow(e,n);if(n.publish&&n.waitFor&&!n.isPublishCallback)this.publishAndWait(e,n);else{if(n.repeat){if(n.isAfterDelay)try{delete n.isAfterDelay}catch(s){n.isAfterDelay=t}this.repeat(e,n)}else n.then&&(n.waitFor?this.isEarlierQuery(n.then,e)?this.rewind(e,n.then,n.waitFor):this.queue(n.then,n.waitFor):this.exec(n.then));if(n.isPublishCallback)try{delete n.isPublishCallback}catch(s){n.isPublishCallback=t}n.timeout&&this.setResponseTimeout(e,n);if(n.isAfterDelay)try{delete n.isAfterDelay}catch(s){n.isAfterDelay=t}}}},setResponseTimeout:function(e,t){this.timers.queries[e]||(this.timers.queries[e]=[]);var n=this,r=setTimeout(function(){n.onResponseTimeout(e,t)},t.timeout.after);this.timers.queries[e].push(r)},repeat:function(e,t){t.repeat.counter+=1,t.repeat.limit===null?this.queue(e,t.waitFor):t.repeat.counter>=t.repeat.limit?(this.publish("Turbine|limit|exceeded|REPEAT",{query:e,limit:t.repeat.limit}),this.processResponse(e,t.repeat)):t.waitFor?(this.utils.isArray(t.waitFor)&&t.repeat.counter>1&&(t.waitFor=t.waitFor.slice(0,t.waitFor.length-this.numGlobalListeners)),this.queue(e,t.waitFor)):this.exec(e)},rewind:function(e,t,n){this.clearTimers();var r=!1,i=this.queryOrder.length;e=e||this.queryOrder[i-1],t=t||this.queryOrder[0],this.publish("Turbine|workflow|rewind",{from:e,to:t});for(var s=i;s>=0;s--){var o=this.queryOrder[s];o===e&&(r=!0),r&&this.clear(o);if(o===t)break}this.isStopped()||this.queue(t,n)},isEarlierQuery:function(e,t){if(t===e)return!0;for(var n in this.queryOrder)if(this.queryOrder.hasOwnProperty(n)){if(this.queryOrder[n]===e)return!0;if(this.queryOrder[n]===t)return!1}return!1},clear:function(e){this.clearQueryTimer(e);for(var t in this.workflow.queries[e])this.workflow.queries[e].hasOwnProperty(t)&&this.workflow.queries[e][t].repeat&&(this.workflow.queries[e][t].repeat.counter=0);this.resetResponse(e)},hasQueryFunction:function(e){return typeof this.queries[e]=="function"},hasResetFunction:function(e){return typeof this.resets[e]=="function"},resetResponse:function(e){this.hasResetFunction(e)?this.responses[e]=this.resets[e]():this.responses[e]=null},onResponseTimeout:function(e,t){this.waitingFor&&this.remove(this.waitingFor),this.publish("Turbine|timer|expired|WORKFLOW_RESPONSE_TIMEOUT",{query:e,response:t.responseName,responseObj:t}),t.timeout.isAfterTimeout=!0,this.processResponse(e,t.timeout,!0)},publishNow:function(e,t){var n=null,r={};this.utils.isObjLiteral(t.publish)?(n=t.publish.message,r=this.getUsingObject(t.publish.using)):n=t.publish,this.publish(n,r)},publishAndWait:function(e,t){var n=this,r=null,i={};this.utils.isObjLiteral(t.publish)?(r=t.publish.message,i=this.getUsingObject(t.publish.using)):r=t.publish,i.counter=typeof t.repeat!="undefined"?t.repeat.counter:0;var s=function(){t.isPublishCallback=!0,n.processResponse(e,t)};this.publish(r,i,s)},getUsingObject:function(e){return e=typeof e=="undefined"?{}:e,this.workflow.config.always&&this.workflow.config.always.using&&(e=this.utils.mergeObjects(e,this.workflow.config.always.using)),e},startDelayTimeout:function(e,t){this.publish("Turbine|delay|started",{query:e,delay:t.delay+" ms"});var n=this;this.timers.delay=setTimeout(function(){n.onDelayTimeout(e,t)},t.delay)},onDelayTimeout:function(e,t){this.publish("Turbine|delay|completed",{query:e,delay:t.delay+" ms"}),t.isAfterDelay=!0,this.processResponse(e,t)},getStartingQuery:function(){var e=this.getConfigShortcut("start");return e?e:this.queryOrder[0]},importGlobalListener:function(e,t){this.replaceShortcuts(e,t),this.replaceVariables(e,t),typeof e.waitFor=="string"&&(e.waitFor=[e.waitFor]);for(var n=0;n<e.waitFor.length;n++){var r=e.waitFor[n];this.globalListeners[r]=e,this.numGlobalListeners+=1}},queue:function(e,t){this.waitingFor&&this.remove(this.waitingFor),this.waitingFor=this.buildWaitingForObj(t),this.nextQueryObj=this.buildNextQueryObj(e,this.waitingFor),this.nextQuery=e,this.publish("Turbine|workflow|waiting",{waitingFor:this.waitingFor}),this.listen(this.waitingFor,this.handleIncomingMessage.bind(this))},buildWaitingForObj:function(e){var t=e?e:[];this.utils.isArray(t)||(t=[t]);for(var n in this.globalListeners)if(this.globalListeners.hasOwnProperty(n))for(var r=0;r<this.globalListeners[n].waitFor.length;r++){var i=this.globalListeners[n].waitFor[r];this.utils.inArray(i,t)||t.push(i)}return t},buildNextQueryObj:function(e,t){var n={};for(var r=0;r<t.length;r++)n[t[r]]=e;for(var i in this.globalListeners)this.globalListeners.hasOwnProperty(i)&&(n[i]=this.globalListeners[i].then);return n},handleIncomingMessage:function(e,t){return this.isStopped()?null:(this.waitingFor&&(this.remove(this.waitingFor),this.nextQuery=this.getNextQuery(e)),this.publish("Turbine|message|handled",{handledMessage:e,next:this.nextQuery}),this.waitingFor=null,this.next(),!0)},getNextQuery:function(e){var t=null;for(var n in this.nextQueryObj)if(this.nextQueryObj.hasOwnProperty(n)&&this.compare(e,n)){t=this.nextQueryObj[n];break}return t},clearTimers:function(){this.clearAllQueryTimers(),this.clearGlobalTimer(),this.clearDelayTimer()},clearAllQueryTimers:function(){for(var e in this.timers.queries)this.timers.queries.hasOwnProperty(e)&&this.clearQueryTimer(e)},clearQueryTimer:function(e){var n=this.timers.queries[e];if(n){for(var r=0;r<n.length;r++)clearTimeout(n[r]);try{delete this.timers.queries[e]}catch(i){this.timers.queries[e]=t}}},clearGlobalTimer:function(){this.timers.global!==null&&(clearTimeout(this.timers.global),this.timers.global=null)},clearDelayTimer:function(){this.timers.delay!==null&&(clearTimeout(this.timers.delay),this.timers.delay=null)},startGlobalTimeout:function(e,t){if(!this.isGlobalTimeoutAllowed())return!1;this.clearGlobalTimer();var n=this.getGlobalTimeout(),r=this;return this.timers.global=setTimeout(function(){r.onGlobalTimeout(e,t)},n),!0},getGlobalTimeout:function(){return this.utils.isObjLiteral(this.workflow.config)&&this.utils.isObjLiteral(this.workflow.config.always)&&this.utils.isObjLiteral(this.workflow.config.always.timeout)&&this.workflow.config.always.timeout.after?this.workflow.config.always.timeout.after:this.defaultGlobalTimeout},onGlobalTimeout:function(e,t){this.waitingFor&&this.remove(this.waitingFor),this.publish("Turbine|timer|expired|WORKFLOW_GLOBAL_TIMEOUT",{query:e,response:t.responseName,responseObj:t}),this.workflow.config.always.timeout.isAfterTimeout=!0,this.processResponse(null,this.workflow.config.always.timeout,!0)},isGlobalTimeoutAllowed:function(){return this.globalTimeoutAllowed===!0},isStopped:function(){return this.stopped===!0},isStopQuery:function(e){return e==="done"},setResponse:function(e,t){this.responses[e]=t},getResponse:function(e){this.responses[e]=this.hasQueryFunction(e)?this.queries[e]():this.responses[e];if(typeof this.responses[e]=="boolean"||!this.responses[e])this.responses[e]=this.responses[e]?"yes":"no";return this.responses[e]},getConfigVar:function(e){return e=e.indexOf("$")!==0?"$"+e:e,this.utils.isObjLiteral(this.workflow.config.variables)?this.workflow.config.variables[e]:null},getConfigShortcut:function(e){return e=e.indexOf("@")!==0?"@"+e:e,this.utils.isObjLiteral(this.workflow.config)&&this.utils.isObjLiteral(this.workflow.config.shortcuts)?this.workflow.config.shortcuts[e]:null},replaceVariables:function(e,t){this.replace(e,t.config.variables,"$",!0,"variable")},replaceShortcuts:function(e,t){this.replace(e,t.config.shortcuts,"@",!0,"shortcut")},replaceMixins:function(e,t){this.replace(t.queries[e],t.mixins,"!",!0,"mixin")},replace:function(e,t,n,r,i){for(var s in e)if(e.hasOwnProperty(s)){var o=e[s];typeof o=="string"&&o.indexOf(n)===0?t[o]&&(e[s]=t[o]):r&&typeof o=="object"&&this.replace(o,t,n,r,i)}},utils:{isArray:function(e){return Object.prototype.toString.call(e)==="[object Array]"},inArray:function(e,t){for(var n=0;n<t.length;n++)if(e===t[n])return!0;return!1},isObjLiteral:function(e){return typeof e=="object"&&e!==null&&!this.isArray(e)},mergeObjects:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(typeof e[n]=="object"&&e[n]!==null&&typeof t[n]=="object"&&t[n]!==null?e[n]=this.mergeObjects(e[n],t[n]):e[n]=t[n]);return e}}},e.Turbine=i})(window);